<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NapCat æ’ä»¶ä»ªè¡¨ç›˜ Â· è‡ªåŠ¨æ¸…ç†</title>
    <style>
        :root {
            --bg: #fff;
            --card: #f8f9fb;
            --muted: #6b7280;
            --accent: #6b46c1;
            --danger: #e11d48
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            font-family: system-ui, Segoe UI, Roboto, 'Noto Sans', Helvetica, Arial
        }

        .wrap {
            max-width: 1200px;
            margin: 14px auto;
            padding: 12px
        }

        .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .brand .icon {
            font-size: 22px
        }

        .controls {
            display: flex;
            gap: 8px
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer
        }

        button.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .layout {
            display: flex;
            gap: 12px;
            margin-top: 12px
        }

        .left {
            flex: 1;
            min-width: 0
        }

        .card {
            background: var(--card);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e6e9ef
        }

        .card+.card {
            margin-top: 12px
        }

        .search {
            display: flex;
            gap: 8px;
            margin-bottom: 8px
        }

        input[type=text],
        input[type=number] {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #dfe4ee;
            width: 100%
        }

        .group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 8px;
            background: #fff;
            margin-bottom: 8px
        }

        .meta {
            color: var(--muted);
            font-size: 13px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .sidebar {
            width: 320px
        }

        .hint {
            color: var(--muted);
            font-size: 13px
        }

        .candidates {
            margin-top: 8px
        }

        .candidate {
            padding: 8px;
            border-radius: 6px;
            background: #fff;
            margin-bottom: 6px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        @media (max-width:900px) {
            .layout {
                flex-direction: column
            }

            .sidebar {
                width: 100%
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="top">
            <div class="brand">
                <div class="icon">ğŸ±</div>
                <div>
                    <div style="font-weight:600">NapCat æ’ä»¶ Â· è‡ªåŠ¨æ¸…ç†</div>
                    <div class="small">ç™½åå•ç®¡ç† Â· å®šæ—¶æ‰«æ</div>
                </div>
            </div>
            <div class="controls">
                <button id="refreshBtn">åˆ·æ–°</button>
                <button id="saveBtn" class="primary">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div class="layout">
            <div class="left">
                <div class="card" id="groupsCard">
                    <div class="row" style="justify-content:space-between;align-items:center">
                        <strong>æœºå™¨äººæ‰€åœ¨ç¾¤</strong>
                        <div class="small hint" id="status">åŠ è½½ä¸­â€¦</div>
                    </div>
                    <div class="search" style="margin-top:8px">
                        <input id="q" type="text" placeholder="æŒ‰ç¾¤åæˆ–ç¾¤å·æœç´¢" />
                        <select id="filter">
                            <option value="all">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div id="groups" style="margin-top:6px">åŠ è½½ä¸­...</div>
                </div>

                <!-- group detail modal -->
                <div id="groupModal"
                    style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:999">
                    <div
                        style="background:#fff;border-radius:8px;padding:16px;min-width:320px;max-width:720px;margin:16px;">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong id="modalTitle">ç¾¤è®¾ç½®</strong>
                            <button onclick="closeGroupModal()">å…³é—­</button>
                        </div>
                        <div style="margin-top:10px">
                            <div class="small">ç¾¤ ID: <span id="modalGroupId" class="small"></span></div>
                            <label class="small" style="margin-top:8px">å¯ç”¨ï¼ˆæ­¤ç¾¤çš„å®šæ—¶ä»»åŠ¡ï¼‰</label>
                            <input id="modalEnabled" type="checkbox" />
                            <label class="small" style="margin-top:8px">Cron è¡¨è¾¾å¼</label>
                            <input id="modalCron" type="text" placeholder="cron è¡¨è¾¾å¼ï¼ˆ5 æˆ– 6 å­—æ®µï¼‰" />
                            <label class="small" style="margin-top:8px">ä¸æ´»è·ƒå¤©æ•°</label>
                            <input id="modalInactiveDays" type="number" min="1" />
                            <label class="small" style="margin-top:8px">æ¶ˆæ¯å†…å®¹</label>
                            <input id="modalMessage" type="text" />
                        </div>
                        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                            <button onclick="closeGroupModal()">å–æ¶ˆ</button>
                            <button class="primary" onclick="saveGroupFromModal()">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <strong>å®šæ—¶ä»»åŠ¡ Â· å…¨å±€é…ç½®</strong>
                    <div style="margin-top:8px" class="hint">node-cronï¼ˆ5 æˆ– 6 å­—æ®µï¼Œä¸èƒ½åŒ…å« ?ï¼‰</div>
                    <div style="margin-top:8px">
                        <label class="small">Cron è¡¨è¾¾å¼</label>
                        <input id="globalCron" type="text" placeholder="ä¾‹å¦‚: 0 8 * * *" />
                        <label class="small" style="margin-top:6px">é»˜è®¤ä¸æ´»è·ƒå¤©æ•°</label>
                        <input id="globalInactiveDays" type="number" min="1" placeholder="30" />
                    </div>
                </div>

                <!-- å·²å°†ç¾¤å•ç‹¬é…ç½®æ•´åˆè‡³ç¾¤åˆ—è¡¨çš„æ¨¡æ€çª—ä¸­ï¼Œç§»é™¤å¿«é€Ÿç¼–è¾‘é¢æ¿ -->
            </div>
        </div>
    </div>

    <script>
        (function () {
            const urlParams = new URLSearchParams(location.search);
            const token = urlParams.get('webui_token') || '';

            function authHeaders(h = {}) { if (token) h['Authorization'] = 'Bearer ' + token; return h }

            async function resolveApiBase() {
                const tries = [];
                if (window.__PLUGIN_NAME__) tries.push(window.__PLUGIN_NAME__);
                try { if (window.parent && window.parent.__PLUGIN_NAME__) tries.push(window.parent.__PLUGIN_NAME__) } catch (e) { }
                const segs = location.pathname.split('/').filter(Boolean);
                if (segs.length) tries.push(segs[segs.length - 1]);
                tries.push('napcat-plugin-auto-clear');
                for (const name of [...new Set(tries)]) {
                    const base = '/api/Plugin/ext/' + name;
                    try { const r = await fetch(base + '/status', { headers: authHeaders() }); if (r.ok) return base } catch (e) { }
                }
                return '/api/Plugin/ext/' + (window.__PLUGIN_NAME__ || 'napcat-plugin-auto-clear');
            }

            function esc(s) { if (!s && s !== 0) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;') }

            let API_BASE_P = resolveApiBase();

            async function fetchJson(path, opts) { const base = await API_BASE_P; const res = await fetch(base + path, Object.assign({}, opts, { headers: Object.assign({ 'Content-Type': 'application/json' }, opts && opts.headers ? opts.headers : {}, authHeaders()) })); return res }

            async function loadStatus() {
                try {
                    const res = await fetchJson('/status', { method: 'GET' });
                    const j = await res.json();
                    document.getElementById('status').innerText = j && j.code === 0 ? ('uptime: ' + (j.data?.uptimeFormatted || '')) : 'å·²è¿æ¥';
                } catch (e) { document.getElementById('status').innerText = 'æ— æ³•è¿æ¥'; }
            }

            async function fetchGroups() {
                const el = document.getElementById('groups'); el.innerHTML = 'åŠ è½½ä¸­...';
                try {
                    const r = await fetchJson('/groups', { method: 'GET' });
                    if (!r.ok) { el.innerText = 'è·å–å¤±è´¥: HTTP ' + r.status; return }
                    const j = await r.json(); if (!j || j.code !== 0) { el.innerText = 'è·å–å¤±è´¥'; return }
                    renderGroups(j.data || []);
                } catch (e) { el.innerText = 'è¯·æ±‚é”™è¯¯: ' + e.message }
            }

            function renderGroups(list) {
                const container = document.getElementById('groups');
                const q = (document.getElementById('q').value || '').trim().toLowerCase();
                const filter = document.getElementById('filter').value;
                const rows = list.filter(g => {
                    if (q) { const t = (g.group_name || '') + '' + g.group_id; if (!t.toLowerCase().includes(q)) return false }
                    // ä»…æ”¯æŒ 'all' è¿‡æ»¤ï¼Œç™½åå•å¼€å…³åœ¨åç«¯é…ç½®ä¸­ç®¡ç†ï¼ˆå¦‚æœ‰ï¼‰
                    return true
                }).map(g => {
                    const id = String(g.group_id);
                    return `<div class="group" data-id="${esc(id)}"><div style="min-width:0">
            <div style="font-weight:600">${esc(g.group_name || id)} <span class="small" style="color:#444">(${esc(id)})</span></div>
                        <div class="meta">æˆå‘˜: ${g.member_count || 0} Â· è§’è‰²: ${esc(g.role || '')} Â· å¯è¸¢: ${g.canKick ? 'æ˜¯' : 'å¦'}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                            <div style="display:flex;gap:6px"><button onclick="openGroupModal('${esc(id)}')">è®¾ç½®</button></div>
                        </div></div>`
                }).join('');
                container.innerHTML = rows || '<div class="small hint">æ— å¯æ˜¾ç¤ºç¾¤</div>';
            }

            // æ‰“å¼€ç¾¤è®¾ç½®æ¨¡æ€çª—ï¼šä»åç«¯è¯»å–è¯¥ç¾¤çš„ cron é…ç½®å¹¶å¡«å……
            async function openGroupModal(groupId) {
                const modal = document.getElementById('groupModal');
                document.getElementById('modalGroupId').innerText = groupId;
                document.getElementById('modalTitle').innerText = 'ç¾¤è®¾ç½® - ' + groupId;
                // reset
                document.getElementById('modalEnabled').checked = false;
                document.getElementById('modalCron').value = '';
                document.getElementById('modalInactiveDays').value = '';
                document.getElementById('modalMessage').value = '';
                modal.style.display = 'flex';
                try {
                    const r = await fetchJson('/groups/' + encodeURIComponent(groupId) + '/cron', { method: 'GET' });
                    if (!r.ok) return;
                    const j = await r.json();
                    const cfg = j.data || {};
                    document.getElementById('modalEnabled').checked = Boolean(cfg.enabled === true);
                    document.getElementById('modalCron').value = cfg.cron || '';
                    document.getElementById('modalInactiveDays').value = cfg.inactiveDays || '';
                    document.getElementById('modalMessage').value = cfg.message || '';
                } catch (e) {
                    console.error('åŠ è½½ç¾¤é…ç½®å¤±è´¥', e);
                }
            }

            function closeGroupModal() {
                const modal = document.getElementById('groupModal');
                modal.style.display = 'none';
            }

            async function saveGroupFromModal() {
                const groupId = document.getElementById('modalGroupId').innerText;
                const enabled = document.getElementById('modalEnabled').checked;
                const cron = document.getElementById('modalCron').value;
                const inactiveDays = document.getElementById('modalInactiveDays').value;
                const message = document.getElementById('modalMessage').value;
                if (cron && !isCronValid(cron)) { alert('cron æ ¼å¼å¯èƒ½æ— æ•ˆï¼ˆ5æˆ–6å­—æ®µï¼Œä¸èƒ½åŒ…å« ?ï¼‰'); return }
                try {
                    const r = await fetchJson('/groups/' + encodeURIComponent(groupId) + '/cron', { method: 'POST', body: JSON.stringify({ enabled, cron: cron || undefined, inactiveDays: inactiveDays ? Number(inactiveDays) : undefined, message: message || undefined }) });
                    const j = await r.json();
                    if (r.ok && j.code === 0) {
                        alert('ä¿å­˜æˆåŠŸ');
                        closeGroupModal();
                        fetchGroups();
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + (j && j.message ? j.message : 'æœªçŸ¥'));
                    }
                } catch (e) {
                    alert('ç½‘ç»œé”™è¯¯: ' + e.message);
                }
            }

            async function loadConfig() {
                try {
                    const r = await fetchJson('/config', { method: 'GET' });
                    if (!r.ok) return; const j = await r.json(); const cfg = j.data || {};
                    document.getElementById('globalCron').value = cfg.globalCron || '';
                    document.getElementById('globalInactiveDays').value = cfg.inactiveDays || '';
                } catch (e) { console.error(e) }
            }

            // ç¾¤å¿«é€Ÿç¼–è¾‘é¢æ¿å·²ç§»é™¤ï¼›ä½¿ç”¨æ¨¡æ€çª—ç®¡ç†å•ç¾¤é…ç½®

            function isCronValid(s) { if (!s) return true; const parts = s.trim().split(/\s+/); return parts.length === 5 || parts.length === 6 ? !s.includes('?') : false }

            async function saveAll() {
                const cron = document.getElementById('globalCron').value; const days = document.getElementById('globalInactiveDays').value;
                if (cron && !isCronValid(cron)) { alert('å…¨å±€ cron æ ¼å¼å¯èƒ½æ— æ•ˆ'); return }
                // åªæäº¤å…¨å±€ä¸ç¾¤é…ç½®ä¸ºç©ºæ—¶ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
                const body = { globalCron: cron || undefined, inactiveDays: days ? Number(days) : undefined };
                try {
                    const r = await fetchJson('/config', { method: 'POST', body: JSON.stringify(body) });
                    const j = await r.json(); if (r.ok && j.code === 0) { alert('ä¿å­˜æˆåŠŸ'); loadConfig() } else { alert('ä¿å­˜å¤±è´¥') }
                } catch (e) { alert('ä¿å­˜å¼‚å¸¸') }
            }

            document.getElementById('refreshBtn').addEventListener('click', () => { fetchGroups(); loadConfig(); });
            document.getElementById('saveBtn').addEventListener('click', saveAll);
            document.getElementById('q').addEventListener('input', () => fetchGroups());
            document.getElementById('filter').addEventListener('change', () => fetchGroups());

            // expose modal handlers to global scope so inline onclick in generated HTML works
            window.openGroupModal = openGroupModal;
            window.closeGroupModal = closeGroupModal;
            window.saveGroupFromModal = saveGroupFromModal;

            // init
            fetchGroups(); loadStatus(); loadConfig();
        })();
    </script>
</body>

</html>